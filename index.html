<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinWise Investor Profiler</title>
    <style>
        :root {
            --primary: #764ba2;
            --secondary: #667eea;
            --accent: #ff6b6b;
            --text-dark: #2d3748;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f2f5;
            display: flex; flex-direction: column; align-items: center; padding: 40px;
            color: var(--text-dark);
        }
        .header { text-align: center; margin-bottom: 30px; }
        
        /* WHEEL STYLING */
        .wheel-container { position: relative; width: 400px; height: 400px; margin-bottom: 30px; }
        #wheel {
            width: 100%; height: 100%; border-radius: 50%;
            border: 8px solid #333; position: relative; overflow: hidden;
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
            background: conic-gradient(
                #ffadad 0deg 40deg, #ffd6a5 40deg 80deg, #fdffb6 80deg 120deg,
                #caffbf 120deg 160deg, #9bf6ff 160deg 200deg, #a0c4ff 200deg 240deg,
                #bdb2ff 240deg 280deg, #ffc6ff 280deg 320deg, #fffffc 320deg 360deg
            );
        }
        .pointer {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 20px solid transparent;
            border-right: 20px solid transparent; border-top: 40px solid #333; z-index: 10;
        }

        /* RIBBON STYLING (Restored) */
        .stock-ribbon-container {
            width: 100%; max-width: 800px; overflow: hidden; white-space: nowrap;
            background: #2d3748; color: white; padding: 10px 0;
            margin-bottom: 20px; border-radius: 8px;
        }
        .stock-ribbon {
            display: inline-block; padding-left: 100%; animation: scroll 20s linear infinite;
        }
        .stock-item { margin-right: 30px; font-weight: bold; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* RESULTS CARD */
        #resultCard {
            max-width: 800px; width: 90%; background: white; padding: 25px;
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none; animation: slideUp 0.5s ease; text-align: center;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } }
        
        .pillar-badge { 
            display: inline-block; padding: 5px 15px; border-radius: 20px; 
            background: var(--secondary); color: white; font-size: 14px; margin-bottom: 10px; font-weight: bold;
        }
        button {
            padding: 15px 40px; font-size: 18px; border: none;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white; border-radius: 30px; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 30px;
        }

        /* TABLE STYLING */
        .stock-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .stock-table th { background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        .stock-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; }
        .stock-table tr:hover { background-color: #f8f9fa; }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyC1hVvK7Yd3qB1Ud3mbIKd_edq4XmH-PVI",
            authDomain: "brave-calling-398109.firebaseapp.com",
            projectId: "brave-calling-398109",
            storageBucket: "brave-calling-398109.firebasestorage.app",
            messagingSenderId: "118774845365",
            appId: "1:118774845365:web:99841a1b01f387a48ed3fc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 2. DATA SOURCE - Using GID 0 (Raw Data) to get Market Cap & Biases columns
        const SHEET_ID = "1W4G9JNnxBMCBOg5c42j1_8AthrTT9wfLIHGkYP5uqxs";
        const GID = "0"; // Changed to RAW DATA sheet to enable correct filtering
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

        const segments = [
            { name: 'Mental Accounting', profile: 'Passive', pillar: 'MANAGE' },
            { name: 'Herd Behavior', profile: 'Moderate', pillar: 'EARN' },
            { name: 'Emotional Gap', profile: 'Passive', pillar: 'MANAGE' },
            { name: 'Anchoring', profile: 'Moderate', pillar: 'GROW' },
            { name: 'Self-Attribution', profile: 'Aggressive', pillar: 'EARN' },
            { name: 'Confirmation Bias', profile: 'Aggressive', pillar: 'GROW' },
            { name: 'Experiential Bias', profile: 'Moderate', pillar: 'GROW' },
            { name: 'Loss Aversion', profile: 'Passive', pillar: 'MANAGE' },
            { name: 'Familiarity Bias', profile: 'Passive', pillar: 'MANAGE' }
        ];

        let currentRotation = 0;

        // 3. SPIN LOGIC
        window.spin = function() {
            const wheel = document.getElementById('wheel');
            const randomExtra = Math.floor(Math.random() * 360) + 1800; 
            currentRotation += randomExtra;
            wheel.style.transform = `rotate(${currentRotation}deg)`;

            document.getElementById('resultCard').style.display = 'none';

            setTimeout(() => {
                const actualDegree = currentRotation % 360;
                const segmentIndex = Math.floor(((360 - actualDegree) % 360) / 40);
                const result = segments[segmentIndex];
                
                displayResult(result);
                saveBiasToFirebase(result.name);
                fetchMarketData(result.name); // Updates Table AND Ribbon
            }, 4000);
        };

        function displayResult(result) {
            const card = document.getElementById('resultCard');
            card.style.display = 'block';
            document.getElementById('pillar').innerText = result.pillar;
            document.getElementById('biasTitle').innerText = result.name;
            document.getElementById('biasDesc').innerText = `Your profile is ${result.profile}. This influences how you ${result.pillar} wealth.`;
        }

        // 4. FETCH & RENDER (Combined Logic)
        async function fetchMarketData(biasName) {
            const tableBody = document.getElementById('tableBody');
            const ribbon = document.getElementById('stockRibbon');
            
            tableBody.innerHTML = '<tr><td colspan="5">Loading Market Data...</td></tr>';
            ribbon.innerHTML = "Fetching Market Data...";

            try {
                const response = await fetch(CSV_URL);
                const text = await response.text();
                // Simple CSV split (handling standard csv export)
                const rows = text.split(/\r?\n/).map(row => row.split(','));

                // MAP COLUMNS based on RAW SHEET (GID 0)
                // D=3(Symbol), I=8(Price), N=13(Market Cap), W=22(Biases), X=23(Category)
                const data = rows.slice(1).map(row => {
                    const clean = (idx) => row[idx] ? row[idx].replace(/"/g, '').trim() : "";
                    return {
                        symbol: clean(3),
                        price: clean(8),
                        marketCap: clean(13),
                        change: clean(12), // Column M is % Change
                        biases: clean(22), // Column W
                        category: clean(23), // Column X
                        pillar: "GROW", 
                        currency: "â‚¹" 
                    };
                }).filter(item => item.symbol && item.symbol !== "Symbol");

                // --- LOGIC 1: FILTER TOP 10 BY MARKET CAP (For Table) ---
                const parseCap = (capStr) => {
                    if(!capStr) return 0;
                    // Remove commas and currency symbols
                    let val = parseFloat(capStr.replace(/[^0-9.]/g, ''));
                    // Check for T/B suffixes just in case, otherwise treat as raw
                    if (capStr.toUpperCase().includes('T')) val *= 1000000000000;
                    else if (capStr.toUpperCase().includes('B')) val *= 1000000000;
                    else if (capStr.toUpperCase().includes('CR')) val *= 10000000;
                    return val || 0;
                };

                const filtered = data
                    .filter(item => item.biases.includes(biasName) || item.biases.includes('All'))
                    .sort((a, b) => parseCap(b.marketCap) - parseCap(a.marketCap))
                    .slice(0, 10);

                // RENDER TABLE
                if (filtered.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5">No specific stocks found for this bias in Top 10.</td></tr>';
                } else {
                    tableBody.innerHTML = filtered.map(stock => `
                        <tr>
                            <td style="font-weight:bold;">${stock.symbol}</td>
                            <td>${stock.category}</td>
                            <td><span class="pillar-badge" style="font-size:10px;">${stock.pillar}</span></td>
                            <td>${stock.currency}${stock.price}</td>
                            <td>${stock.marketCap}</td>
                        </tr>
                    `).join('');
                }

                // --- LOGIC 2: RENDER RIBBON (Restored) ---
                // We show the filtered stocks in the ribbon as well
                let ribbonHtml = filtered.map(item => `
                    <span class="stock-item">
                        ${item.symbol}: ${item.currency}${item.price} 
                        <span style="color: ${item.change?.includes('-') ? '#ff4d4d' : '#2ecc71'};">(${item.change}%)</span>
                    </span>`).join('');
                
                ribbon.innerHTML = ribbonHtml || "No Data Available";

            } catch (error) {
                console.error("Data Load Error:", error);
                tableBody.innerHTML = '<tr><td colspan="5" style="color:red;">Error loading market data. Check Console.</td></tr>';
            }
        }

        async function saveBiasToFirebase(biasName) {
            const user = auth.currentUser;
            if (user) {
                try {
                    await setDoc(doc(db, "users", user.uid), { bias: biasName }, { merge: true });
                } catch (e) { console.error("Firebase Save Error:", e); }
            }
        }

        document.getElementById('spinBtn').addEventListener('click', window.spin);

        function loadApp(appName) {
    // Target the container where content should be displayed
    const container = document.getElementById('app-container');
    
    // Clear previous content (optional, depending on your needs)
    container.innerHTML = '';

    if (appName === 'PortfolioDownload') {
        // Create the HTML structure for the embedded sheet
        const embedHTML = `
            <div class="sheet-wrapper" style="max-width: 100%; margin: 0 auto; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow: hidden; background: #fff;">
                <div style="background-color: #f8f9fa; padding: 15px; border-bottom: 1px solid #ddd;">
                    <h4 style="margin: 0; text-align: center;">Portfolio Update Form</h4>
                </div>
                <iframe 
                    src="https://docs.google.com/spreadsheets/d/11-G1tbWMxIrPVCi1npZOCfs-MZmr_4qBobcRCyP_viE/edit?usp=sharing&widget=true&headers=false&rm=minimal" 
                    style="width: 100%; height: 800px; border: none; display: block;" 
                    title="Portfolio Spreadsheet">
                    Loading...
                </iframe>
            </div>
        `;
        
        // Inject the HTML into the container
        container.innerHTML = embedHTML;
    }
    
    // You can add 'else if' blocks here for other app names if needed
}
    </script>
</head>
<body>

    <div class="header">
        <h1>ðŸŽ¡ FinWise Investor Behavior Wheel</h1>
        <p>Identify your bias to unlock your F11 Portfolio</p>
    </div>

    <div class="stock-ribbon-container">
        <div id="stockRibbon" class="stock-ribbon">
            Spin the wheel to load tailored stock picks...
        </div>
    </div>

    <div class="wheel-container">
        <div class="pointer"></div>
        <div id="wheel"></div>
    </div>

    <button id="spinBtn">Identify My Bias</button>

    <div id="resultCard">
        <div id="pillar" class="pillar-badge"></div>
        <h2 id="biasTitle"></h2>
        <p id="biasDesc"></p>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        
        <h3 id="portfolioRec">Recommended Strategy (Top 10 High-Cap)</h3>
        
        <div style="overflow-x: auto;">
            <table class="stock-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Inv. Category</th>
                        <th>Pillar</th>
                        <th>Price</th>
                        <th>Market Cap</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

</body>
</html>
